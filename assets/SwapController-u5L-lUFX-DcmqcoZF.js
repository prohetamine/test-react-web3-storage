import{a4 as O,a5 as G,x as d,Z as v,i as g,d as D,z as S,b as B,o as M,$ as F,C as p,a6 as b,e as _,a7 as I,w as x,F as R,j as W,a8 as H,J as V,a9 as $,aa as Q}from"./index-DYqKnSl7.js";const P={getGasPriceInEther(o,t){const n=t*o;return Number(n)/1e18},getGasPriceInUSD(o,t,n){const a=P.getGasPriceInEther(t,n);return d.bigNumber(o).times(a).toNumber()},getPriceImpact({sourceTokenAmount:o,sourceTokenPriceInUSD:t,toTokenPriceInUSD:n,toTokenAmount:a}){const r=d.bigNumber(o).times(t),i=d.bigNumber(a).times(n);return r.minus(i).div(r).times(100).toNumber()},getMaxSlippage(o,t){const n=d.bigNumber(o).div(100);return d.multiply(t,n).toNumber()},getProviderFee(o,t=.0085){return d.bigNumber(o).times(t).toString()},isInsufficientNetworkTokenForGas(o,t){const n=t||"0";return d.bigNumber(o).eq(0)?!0:d.bigNumber(d.bigNumber(n)).gt(o)},isInsufficientSourceTokenForSwap(o,t,n){var a,r;const i=(r=(a=n?.find(c=>c.address===t))==null?void 0:a.quantity)==null?void 0:r.numeric;return d.bigNumber(i||"0").lt(o)}},z=15e4,q=6,u={initializing:!1,initialized:!1,loadingPrices:!1,loadingQuote:!1,loadingApprovalTransaction:!1,loadingBuildTransaction:!1,loadingTransaction:!1,switchingTokens:!1,fetchError:!1,approvalTransaction:void 0,swapTransaction:void 0,transactionError:void 0,sourceToken:void 0,sourceTokenAmount:"",sourceTokenPriceInUSD:0,toToken:void 0,toTokenAmount:"",toTokenPriceInUSD:0,networkPrice:"0",networkBalanceInUSD:"0",networkTokenSymbol:"",inputError:void 0,slippage:W.CONVERT_SLIPPAGE_TOLERANCE,tokens:void 0,popularTokens:void 0,suggestedTokens:void 0,foundTokens:void 0,myTokensWithBalance:void 0,tokensPriceMap:{},gasFee:"0",gasPriceInUSD:0,priceImpact:void 0,maxSlippage:void 0,providerFee:void 0},e=G({...u}),E={state:e,subscribe(o){return Q(e,()=>o(e))},subscribeKey(o,t){return $(e,o,t)},getParams(){var o,t,n,a,r,i,c,l,m;const T=p.state.activeChain,k=((o=p.getAccountData(T))==null?void 0:o.caipAddress)??p.state.activeCaipAddress,A=_.getPlainAddress(k),f=H(),C=V.getConnectorId(p.state.activeChain);if(!A)throw new Error("No address found to swap the tokens from.");const y=!((t=e.toToken)!=null&&t.address)||!((n=e.toToken)!=null&&n.decimals),h=!((a=e.sourceToken)!=null&&a.address)||!((r=e.sourceToken)!=null&&r.decimals)||!d.bigNumber(e.sourceTokenAmount).gt(0),N=!e.sourceTokenAmount;return{networkAddress:f,fromAddress:A,fromCaipAddress:k,sourceTokenAddress:(i=e.sourceToken)==null?void 0:i.address,toTokenAddress:(c=e.toToken)==null?void 0:c.address,toTokenAmount:e.toTokenAmount,toTokenDecimals:(l=e.toToken)==null?void 0:l.decimals,sourceTokenAmount:e.sourceTokenAmount,sourceTokenDecimals:(m=e.sourceToken)==null?void 0:m.decimals,invalidToToken:y,invalidSourceToken:h,invalidSourceTokenAmount:N,availableToSwap:k&&!y&&!h&&!N,isAuthConnector:C===S.CONNECTOR_ID.AUTH}},async setSourceToken(o){if(!o){e.sourceToken=o,e.sourceTokenAmount="",e.sourceTokenPriceInUSD=0;return}e.sourceToken=o,await s.setTokenPrice(o.address,"sourceToken")},setSourceTokenAmount(o){e.sourceTokenAmount=o},async setToToken(o){if(!o){e.toToken=o,e.toTokenAmount="",e.toTokenPriceInUSD=0;return}e.toToken=o,await s.setTokenPrice(o.address,"toToken")},setToTokenAmount(o){e.toTokenAmount=o?d.toFixed(o,q):""},async setTokenPrice(o,t){let n=e.tokensPriceMap[o]||0;n||(e.loadingPrices=!0,n=await s.getAddressPrice(o)),t==="sourceToken"?e.sourceTokenPriceInUSD=n:t==="toToken"&&(e.toTokenPriceInUSD=n),e.loadingPrices&&(e.loadingPrices=!1),s.getParams().availableToSwap&&!e.switchingTokens&&s.swapTokens()},async switchTokens(){if(!(e.initializing||!e.initialized||e.switchingTokens)){e.switchingTokens=!0;try{const o=e.toToken?{...e.toToken}:void 0,t=e.sourceToken?{...e.sourceToken}:void 0,n=o&&e.toTokenAmount===""?"1":e.toTokenAmount;s.setSourceTokenAmount(n),s.setToTokenAmount(""),await s.setSourceToken(o),await s.setToToken(t),e.switchingTokens=!1,s.swapTokens()}catch(o){throw e.switchingTokens=!1,o}}},resetState(){e.myTokensWithBalance=u.myTokensWithBalance,e.tokensPriceMap=u.tokensPriceMap,e.initialized=u.initialized,e.initializing=u.initializing,e.switchingTokens=u.switchingTokens,e.sourceToken=u.sourceToken,e.sourceTokenAmount=u.sourceTokenAmount,e.sourceTokenPriceInUSD=u.sourceTokenPriceInUSD,e.toToken=u.toToken,e.toTokenAmount=u.toTokenAmount,e.toTokenPriceInUSD=u.toTokenPriceInUSD,e.networkPrice=u.networkPrice,e.networkTokenSymbol=u.networkTokenSymbol,e.networkBalanceInUSD=u.networkBalanceInUSD,e.inputError=u.inputError},resetValues(){var o;const{networkAddress:t}=s.getParams(),n=(o=e.tokens)==null?void 0:o.find(a=>a.address===t);s.setSourceToken(n),s.setToToken(void 0)},getApprovalLoadingState(){return e.loadingApprovalTransaction},clearError(){e.transactionError=void 0},async initializeState(){if(!e.initializing){if(e.initializing=!0,!e.initialized)try{await s.fetchTokens(),e.initialized=!0}catch{e.initialized=!1,g.showError("Failed to initialize swap"),v.goBack()}e.initializing=!1}},async fetchTokens(){var o;const{networkAddress:t}=s.getParams();await s.getNetworkTokenPrice(),await s.getMyTokensWithBalance();const n=(o=e.myTokensWithBalance)==null?void 0:o.find(a=>a.address===t);n&&(e.networkTokenSymbol=n.symbol,s.setSourceToken(n),s.setSourceTokenAmount("0"))},async getTokenList(){var o,t;const n=(o=p.state.activeCaipNetwork)==null?void 0:o.caipNetworkId;if(!(e.caipNetworkId===n&&e.tokens))try{e.tokensLoading=!0;const a=await I.getTokenList(n);e.tokens=a,e.caipNetworkId=n,e.popularTokens=a.sort((c,l)=>c.symbol<l.symbol?-1:c.symbol>l.symbol?1:0);const r=(n&&((t=W.SUGGESTED_TOKENS_BY_CHAIN)==null?void 0:t[n])||[]).map(c=>a.find(l=>l.symbol===c)).filter(c=>!!c),i=(W.SWAP_SUGGESTED_TOKENS||[]).map(c=>a.find(l=>l.symbol===c)).filter(c=>!!c).filter(c=>!r.some(l=>l.address===c.address));e.suggestedTokens=[...r,...i]}catch{e.tokens=[],e.popularTokens=[],e.suggestedTokens=[]}finally{e.tokensLoading=!1}},async getAddressPrice(o){var t,n;const a=e.tokensPriceMap[o];if(a)return a;const r=await b.fetchTokenPrice({addresses:[o]}),i=r?.fungibles||[],c=[...e.tokens||[],...e.myTokensWithBalance||[]],l=(t=c?.find(k=>k.address===o))==null?void 0:t.symbol,m=((n=i.find(k=>k.symbol.toLowerCase()===l?.toLowerCase()))==null?void 0:n.price)||0,T=parseFloat(m.toString());return e.tokensPriceMap[o]=T,T},async getNetworkTokenPrice(){var o;const{networkAddress:t}=s.getParams(),n=(o=(await b.fetchTokenPrice({addresses:[t]}).catch(()=>(g.showError("Failed to fetch network token price"),{fungibles:[]}))).fungibles)==null?void 0:o[0],a=n?.price.toString()||"0";e.tokensPriceMap[t]=parseFloat(a),e.networkTokenSymbol=n?.symbol||"",e.networkPrice=a},async getMyTokensWithBalance(o){var t;const n=await R.getMyTokensWithBalance({forceUpdate:o,caipNetwork:p.state.activeCaipNetwork,address:(t=p.getAccountData())==null?void 0:t.address}),a=I.mapBalancesToSwapTokens(n);a&&(await s.getInitialGasPrice(),s.setBalances(a))},setBalances(o){const{networkAddress:t}=s.getParams(),n=p.state.activeCaipNetwork;if(!n)return;const a=o.find(r=>r.address===t);o.forEach(r=>{e.tokensPriceMap[r.address]=r.price||0}),e.myTokensWithBalance=o.filter(r=>r.address.startsWith(n.caipNetworkId)),e.networkBalanceInUSD=a?d.multiply(a.quantity.numeric,a.price).toString():"0"},async getInitialGasPrice(){var o,t;const n=await I.fetchGasPrice();if(!n)return{gasPrice:null,gasPriceInUSD:null};switch((t=(o=p.state)==null?void 0:o.activeCaipNetwork)==null?void 0:t.chainNamespace){case S.CHAIN.SOLANA:return e.gasFee=n.standard??"0",e.gasPriceInUSD=d.multiply(n.standard,e.networkPrice).div(1e9).toNumber(),{gasPrice:BigInt(e.gasFee),gasPriceInUSD:Number(e.gasPriceInUSD)};case S.CHAIN.EVM:default:const a=n.standard??"0",r=BigInt(a),i=BigInt(z),c=P.getGasPriceInUSD(e.networkPrice,i,r);return e.gasFee=a,e.gasPriceInUSD=c,{gasPrice:r,gasPriceInUSD:c}}},async swapTokens(){var o,t,n;const a=(o=p.getAccountData())==null?void 0:o.address,r=e.sourceToken,i=e.toToken,c=d.bigNumber(e.sourceTokenAmount).gt(0);if(c||s.setToTokenAmount(""),!i||!r||e.loadingPrices||!c||!a)return;e.loadingQuote=!0;const l=d.bigNumber(e.sourceTokenAmount).times(10**r.decimals).round(0);try{const m=await b.fetchSwapQuote({userAddress:a,from:r.address,to:i.address,gasPrice:e.gasFee,amount:l.toString()});e.loadingQuote=!1;const T=(n=(t=m?.quotes)==null?void 0:t[0])==null?void 0:n.toAmount;if(!T){x.open({displayMessage:"Incorrect amount",debugMessage:"Please enter a valid amount"},"error");return}const k=d.bigNumber(T).div(10**i.decimals).toString();s.setToTokenAmount(k),s.hasInsufficientToken(e.sourceTokenAmount,r.address)?e.inputError="Insufficient balance":(e.inputError=void 0,s.setTransactionDetails())}catch(m){const T=await I.handleSwapError(m);e.loadingQuote=!1,e.inputError=T||"Insufficient balance"}},async getTransaction(){const{fromCaipAddress:o,availableToSwap:t}=s.getParams(),n=e.sourceToken,a=e.toToken;if(!(!o||!t||!n||!a||e.loadingQuote))try{e.loadingBuildTransaction=!0;const r=await I.fetchSwapAllowance({userAddress:o,tokenAddress:n.address,sourceTokenAmount:e.sourceTokenAmount,sourceTokenDecimals:n.decimals});let i;return r?i=await s.createSwapTransaction():i=await s.createAllowanceTransaction(),e.loadingBuildTransaction=!1,e.fetchError=!1,i}catch{v.goBack(),g.showError("Failed to check allowance"),e.loadingBuildTransaction=!1,e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}},async createAllowanceTransaction(){const{fromCaipAddress:o,sourceTokenAddress:t,toTokenAddress:n}=s.getParams();if(!(!o||!n)){if(!t)throw new Error("createAllowanceTransaction - No source token address found.");try{const a=await b.generateApproveCalldata({from:t,to:n,userAddress:o}),r=_.getPlainAddress(a.tx.from);if(!r)throw new Error("SwapController:createAllowanceTransaction - address is required");const i={data:a.tx.data,to:r,gasPrice:BigInt(a.tx.eip155.gasPrice),value:BigInt(a.tx.value),toAmount:e.toTokenAmount};return e.swapTransaction=void 0,e.approvalTransaction={data:i.data,to:i.to,gasPrice:i.gasPrice,value:i.value,toAmount:i.toAmount},{data:i.data,to:i.to,gasPrice:i.gasPrice,value:i.value,toAmount:i.toAmount}}catch{v.goBack(),g.showError("Failed to create approval transaction"),e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}}},async createSwapTransaction(){var o;const{networkAddress:t,fromCaipAddress:n,sourceTokenAmount:a}=s.getParams(),r=e.sourceToken,i=e.toToken;if(!n||!a||!r||!i)return;const c=(o=D.parseUnits(a,r.decimals))==null?void 0:o.toString();try{const l=await b.generateSwapCalldata({userAddress:n,from:r.address,to:i.address,amount:c,disableEstimate:!0}),m=r.address===t,T=BigInt(l.tx.eip155.gas),k=BigInt(l.tx.eip155.gasPrice),A=_.getPlainAddress(l.tx.to);if(!A)throw new Error("SwapController:createSwapTransaction - address is required");const f={data:l.tx.data,to:A,gas:T,gasPrice:k,value:BigInt(m?c??"0":"0"),toAmount:e.toTokenAmount};return e.gasPriceInUSD=P.getGasPriceInUSD(e.networkPrice,T,k),e.approvalTransaction=void 0,e.swapTransaction=f,f}catch{v.goBack(),g.showError("Failed to create transaction"),e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}},onEmbeddedWalletApprovalSuccess(){g.showLoading("Approve limit increase in your wallet"),v.replace("SwapPreview")},async sendTransactionForApproval(o){var t,n,a;const{fromAddress:r,isAuthConnector:i}=s.getParams();e.loadingApprovalTransaction=!0,i?v.pushTransactionStack({onSuccess:s.onEmbeddedWalletApprovalSuccess}):g.showLoading("Approve limit increase in your wallet");try{await D.sendTransaction({address:r,to:o.to,data:o.data,value:o.value,chainNamespace:S.CHAIN.EVM}),await s.swapTokens(),await s.getTransaction(),e.approvalTransaction=void 0,e.loadingApprovalTransaction=!1}catch(c){const l=c;e.transactionError=l?.displayMessage,e.loadingApprovalTransaction=!1,g.showError(l?.displayMessage||"Transaction error"),B.sendEvent({type:"track",event:"SWAP_APPROVAL_ERROR",properties:{message:l?.displayMessage||l?.message||"Unknown",network:((t=p.state.activeCaipNetwork)==null?void 0:t.caipNetworkId)||"",swapFromToken:((n=s.state.sourceToken)==null?void 0:n.symbol)||"",swapToToken:((a=s.state.toToken)==null?void 0:a.symbol)||"",swapFromAmount:s.state.sourceTokenAmount||"",swapToAmount:s.state.toTokenAmount||"",isSmartAccount:M(S.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}})}},async sendTransactionForSwap(o){var t,n,a,r,i,c,l,m,T,k,A,f;if(!o)return;const{fromAddress:C,toTokenAmount:y,isAuthConnector:h}=s.getParams();e.loadingTransaction=!0;const N=`Swapping ${(t=e.sourceToken)==null?void 0:t.symbol} to ${d.formatNumberToLocalString(y,3)} ${(n=e.toToken)==null?void 0:n.symbol}`,L=`Swapped ${(a=e.sourceToken)==null?void 0:a.symbol} to ${d.formatNumberToLocalString(y,3)} ${(r=e.toToken)==null?void 0:r.symbol}`;h?v.pushTransactionStack({onSuccess(){v.replace("Account"),g.showLoading(N),E.resetState()}}):g.showLoading("Confirm transaction in your wallet");try{const U=[(i=e.sourceToken)==null?void 0:i.address,(c=e.toToken)==null?void 0:c.address].join(","),w=await D.sendTransaction({address:C,to:o.to,data:o.data,value:o.value,chainNamespace:S.CHAIN.EVM});return e.loadingTransaction=!1,g.showSuccess(L),B.sendEvent({type:"track",event:"SWAP_SUCCESS",properties:{network:((l=p.state.activeCaipNetwork)==null?void 0:l.caipNetworkId)||"",swapFromToken:((m=s.state.sourceToken)==null?void 0:m.symbol)||"",swapToToken:((T=s.state.toToken)==null?void 0:T.symbol)||"",swapFromAmount:s.state.sourceTokenAmount||"",swapToAmount:s.state.toTokenAmount||"",isSmartAccount:M(S.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}}),E.resetState(),h||v.replace("Account"),E.getMyTokensWithBalance(U),w}catch(U){const w=U;e.transactionError=w?.displayMessage,e.loadingTransaction=!1,g.showError(w?.displayMessage||"Transaction error"),B.sendEvent({type:"track",event:"SWAP_ERROR",properties:{message:w?.displayMessage||w?.message||"Unknown",network:((k=p.state.activeCaipNetwork)==null?void 0:k.caipNetworkId)||"",swapFromToken:((A=s.state.sourceToken)==null?void 0:A.symbol)||"",swapToToken:((f=s.state.toToken)==null?void 0:f.symbol)||"",swapFromAmount:s.state.sourceTokenAmount||"",swapToAmount:s.state.toTokenAmount||"",isSmartAccount:M(S.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}});return}},hasInsufficientToken(o,t){return P.isInsufficientSourceTokenForSwap(o,t,e.myTokensWithBalance)},setTransactionDetails(){const{toTokenAddress:o,toTokenDecimals:t}=s.getParams();!o||!t||(e.gasPriceInUSD=P.getGasPriceInUSD(e.networkPrice,BigInt(e.gasFee),BigInt(z)),e.priceImpact=P.getPriceImpact({sourceTokenAmount:e.sourceTokenAmount,sourceTokenPriceInUSD:e.sourceTokenPriceInUSD,toTokenPriceInUSD:e.toTokenPriceInUSD,toTokenAmount:e.toTokenAmount}),e.maxSlippage=P.getMaxSlippage(e.slippage,e.toTokenAmount),e.providerFee=P.getProviderFee(e.sourceTokenAmount))}},s=O(E);export{s as a};
